<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Animics</title>
        <link rel="icon" type="image/x-icon" href="data/imgs/animics_monster.png" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:400,700" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic" rel="stylesheet" type="text/css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.css" rel="stylesheet" />

		<!-- <link rel="stylesheet" href="https://cdn.skypack.dev/lexgui@0.1.46/build/lexgui.css"> -->
		<link rel="stylesheet" href="./src/libs/lexgui/build/lexgui.css">
		<link rel="stylesheet" href="css/style.css">
    </head>

	<script src="src/libs/image-map-highlighter.js"></script>

	<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
	<script type="importmap">
			{
				"imports": {
					"three": "https://cdn.skypack.dev/three@0.136",
					
					"lexgui": "./src/libs/lexgui/build/lexgui.module.js",
					"lexgui/components/": "./src/libs/lexgui/build/components/"
				}
			}
	</script>

	<script  type="text/javascript" src="./src/libs/jszip.min.js"></script>
	
	<script type="module" src="src/CustomLibs.js"></script>
	<script type="text/javascript" src="src/timelineClips.js"></script>
	
	<script  type="module" src="./src/libs/lexgui/LexGUI.patches.js"></script>
	<script type="module">

		import { Animics } from './src/Animics.js'
		import { UTILS } from './src/Utils.js'
		import { LX } from 'lexgui';

		let area = LX.init( { strictViewport: false, rootClass: "" } );

		// Menubar
		{
			const menubar = area.addMenubar( m => {

				m.setButtonImage("Animics", "data/imgs/animics_logo.png", () => { window.location = window.location }, { float: "left" })

				m.add( "Docs", { icon: "", callback: () => { } });
				m.add( "About", { icon: "", callback: () => { } });
			});

			area = menubar.siblingArea;
			area.root.style.placeContent = "center";
			area.root.classList.add( "hidden" );
		}

		const content = LX.makeContainer( ["100%", "auto"], "wrapper flex flex-col", "", area );

		// const mainLogo = document.createElement( "img" );
		// mainLogo.src = "docs/animics_white.png";
		// mainLogo.style.width = "700px";
		// content.appendChild( mainLogo );
		// content.appendChild( document.createElement("br") )
		const headerContent = LX.makeContainer( ["100%", "auto"], "flex flex-col items-center my-4", "", content );
		const mainTitle = LX.makeContainer( ["100%", "auto"], "font-medium p-6 mt-4", "Express more. Animate easier.", headerContent, { fontSize: "72px", textAlign: "center" } );
		const subtitle = LX.makeContainer( ["40%", "auto"], "text-xxl font-medium fg-tertiary", "End-to-end system able to generate animations of the signing avatar from user input.", headerContent, { textAlign: "center", lineHeight: "1.6rem" } );

		const startButton = LX.makeContainer( ["20%", "auto"], "my-4 text-xxl font-medium rounded-lg p-4 bg-accent fg-primary cursor-pointer", "Get started", headerContent, { textAlign: "center" } );
		startButton.tabIndex = "1";
		startButton.listen( "click", () => window.__startingContent.scrollIntoView({ behavior: 'smooth', block: 'start' }) );

		const mainCards = LX.makeContainer( ["100%", "600px"], "flex flex-row p-4 gap-4 mt-4", "", headerContent );
		const mediaCardSources = [ "docs/bml_animation.mp4", "docs/bml_animation.mp4", "docs/bml_animation.mp4", "docs/bml_animation.mp4" ];

		for( const mediaIdx in mediaCardSources )
		{
			const cardWidth = 100 / mediaCardSources.length;
			const card = LX.makeContainer( [`${ cardWidth }%`, "100%"], "", "", mainCards );
			const videoElement = document.createElement( "video" );
			videoElement.src = mediaCardSources[ mediaIdx ];
			videoElement.style.width = "100%";
			videoElement.style.height = "100%";
			videoElement.style.objectFit = "cover";
			videoElement.style.borderRadius = "0.5rem";
			videoElement.autoplay = true;
			videoElement.loop = true;
			card.appendChild( videoElement );
		}

		// Utilities
		{
			const utilitiesContent = LX.makeContainer( ["100%", "auto"], "flex flex-col my-4", "", content );
			const mainUtilitiesTitle = LX.makeContainer( ["60%", "auto"], "font-medium p-4 mt-4", "Create stunning 3D animations from simple videos", utilitiesContent, { fontSize: "56px" } );
			const utilitiesSubtitle = LX.makeContainer( ["40%", "auto"], "text-xxl font-medium fg-tertiary px-4", "Transform raw footage into professional animations in four easy steps", utilitiesContent, { lineHeight: "1.6rem" } );
			const utilitiesContainer = LX.makeContainer( ["100%", "512px"], "flex flex-row p-6 gap-2 mt-4", "", utilitiesContent );
			const utilitiesItems = LX.makeContainer( ["35%", "100%"], "flex flex-col gap-2", "", utilitiesContainer );

			const makeUtility = ( title, subtitle, src ) => {
				const item = LX.makeContainer( ["100%", "auto"], "flex flex-col gap-1 p-4 rounded-lg cursor-pointer select-none hover:bg-secondary", "", utilitiesItems );
				LX.makeContainer( ["100%", "auto"], "font-medium text-xl", title, item );
				LX.makeContainer( ["100%", "auto"], "font-medium fg-tertiary line-clamp-3", subtitle, item );
				item.listen( "click", () => {
					videoElement.src = src;
				} );
			};

			// Items
			{
				makeUtility( "Effortless video import", "Upload any video - from smartphone footage to online clips. Our AI instantly extracts precise motion data.", "docs/bml_animation.mp4");
				makeUtility( "Seamless model animation", "Import your 3D character and apply extracted motion. Blinking and physics are supported for MMD and VRM models.", "docs/bml_animation.mp4" );
				makeUtility( "Intuitive video direction", "Just a few clicks for lighting and camera control. Add cinematic effects like motion blur and depth-of-field", "docs/bml_animation.mp4" );
				makeUtility( "Versatile export options", "Generate high-quality video renders or export 3D assets compatible with industry-standard tools like Unreal, Maya, and Blender.", "docs/bml_animation.mp4" );
			}

			const utilitiesPreview = LX.makeContainer( ["65%", "100%"], "", "", utilitiesContainer );
			const videoElement = document.createElement( "video" );
			videoElement.src = "docs/bml_animation.mp4";
			videoElement.style.width = "100%";
			videoElement.style.height = "100%";
			videoElement.style.objectFit = "cover";
			videoElement.style.borderRadius = "0.5rem";
			videoElement.autoplay = true;
			videoElement.loop = true;
			utilitiesPreview.appendChild( videoElement );
		}

		// Getting started
		{
			const startingContent = LX.makeContainer( ["100%", "auto"], "flex flex-col my-4 items-center", "", content );
			window.__startingContent = startingContent;
			const startingTitle = LX.makeContainer( ["60%", "auto"], "font-medium p-4 mt-4", "3D animation has never been easier", startingContent, { fontSize: "56px", textAlign: "center" } );
			const startingSubtitle = LX.makeContainer( ["40%", "auto"], "text-xxl font-medium fg-tertiary px-4", "Start new animation project based on text or video.", startingContent, {  textAlign: "center", lineHeight: "1.6rem" } );
			const buttons = LX.makeContainer( ["100%", "auto"], "flex flex-col items-center mt-8", `
				<div class="flex flex-row gap-4">
					<a id="script-project" class="btn btn-primary btn-xl uppercase" style="width: 18em" title="From text instructions">Script animation</a>
					<a id="keyframe-project" class="btn btn-primary btn-xl uppercase" style="width: 18em" title="From video or webcam input">Keyframe animation</a>
				</div>
				<p class="text-md fg-secondary p-4">or</p>
				<a id="import" class="btn btn-drag btn-xl uppercase" title="Import video or animation">Import source</a>
			`, startingContent );
		}


		const footer = new LX.Footer( {
			className: "",
			parent: LX.root,
			columns: [
				{
					title: "APPLICATIONS",
					items: [
						{ title: `<img src = "data/imgs/performs_monster.png" width = "25px" draggable="false"> PERFORMS`, link: "https://performs.gti.upf.edu/" },
						{ title: `<img src = "data/imgs/animics_logo.png" width = "25px" draggable="false"> ANIMICS`, link: "https://animics.gti.upf.edu/" }
					]
				}
			],
			credits: `2021-${ new Date().getUTCFullYear() } GTI - UPF | This application has been developed within the <a href="https://signon-project.eu/" target="_blank">SignON PROJECT</a>. Released under the Apache 2.0 License.`,
			socials: [
				{ title: "Github", link: "https://github.com/jxarco/lexgui.js/", icon: `<a class="fa-brands fa-github"></a>` },
				{ title: "Discord", link: "https://discord.gg/vwqVrMZBXv", icon: `<a class="fa-brands fa-discord"></a>` }
			]
		} );

		const body = area.root;

		const keyframeBtn = document.getElementById("keyframe-project");
		// const videoBtn = document.getElementById("video-project");
		// const webcamBtn = document.getElementById("webcam-project");

		const scriptBtn = document.getElementById("script-project");
		const importBtn = document.getElementById("import");
		// const importScriptBtn = document.getElementById("import-script");

		// Wait until the session is loaded
		UTILS.makeLoading("Loading application, please wait");
		const animics = new Animics();
		await animics.loadSession();
		UTILS.hideLoading();
		body.classList.remove("hidden");

		const startAnimics = (settings) => {
			const loadingAnim = UTILS.makeLoading("Starting Animics");
			loadingAnim.onfinish = () =>{
				body.innerHTML = "";				
				animics.init(settings);
			};			
			window.global = {app: animics};
		}
		
		const onLoadFiles = function( files ){
			if(!files || !files.length) { 
				return null; 
			}
			
			let mode = null;
			let resultFiles = [];
			
			const animExtensions = ['bvh','bvhe', 'glb'];
			const scriptExtensions = ['json', 'bml', 'sigml'];

			// First valid file will determine the mode. Following files must be of the same format
			for( let i = 0; i < files.length; ++i ) {
				// MIME type is video
				if( files[i].type.startsWith("video/") ) {
					if ( !mode ) { 
						mode = "keyframe"; 
					}
					
					if ( mode == "keyframe" ) {			
						resultFiles.push( files[i] );
					}
					continue;
				}

				// other valid file formats
				const extension = UTILS.getExtension(files[i].name).toLowerCase();
								
				if( animExtensions.includes(extension) ) {
					if ( !mode ) {
						mode = "keyframe";
					}
					
					if ( mode == "keyframe") {
						resultFiles.push( files[i] );
					}
				}

				if( scriptExtensions.includes(extension) ) {
					if ( !mode ) {
						mode = "script";
					}

					if ( mode == "script") {
						resultFiles.push( files[i] );
					}
				}
			}

			if ( resultFiles.length ) {
				return startAnimics({ mode, pendingResources: resultFiles});
			}	
				
			alert("Format not supported.\n\nFormats accepted:\n\tVideo: 'webm','mp4','ogv','avi'\n\tScript animation: 'bml', 'sigml', 'json'\n\tKeyframe animation: 'bvh', 'bvhe'");
			return null;
		}

		// Keyframe mode
		keyframeBtn.addEventListener("click", () => {
			startAnimics({mode: "keyframe"});
		});

		// Script mode
		scriptBtn.addEventListener("click", () => {
			startAnimics({mode: "script"});
		});

		// Import resurces 
		importBtn.addEventListener("click", () => {
    		const input = document.createElement('input');
    		input.type = 'file';
    		input.click();
    		input.onchange = (event) => { 
				onLoadFiles( event.currentTarget.files);
				// startAnimics({pendingResources: event.currentTarget.files})
			};
		});

		body.ondragover = () => {return false};
		body.ondragend = () => {return false};
		body.ondrop = (event) => {
			event.preventDefault();
			event.stopPropagation();
			if ( onLoadFiles( event.dataTransfer.files ) ){
				body.ondrop = null;
			}
		};
	</script>

    <body >
		<!-- <img src="data/imgs/GTIlogo.png" width="250px" style="filter:invert(0.5)" draggable="false"> -->
		<!-- Modals -->
		<div id="loading" class="modal hidden" style="opacity: 1; z-index: 1040">
			<div>
				<p>Loading application, please wait</p>
				<img class="loading-icon" src="data/imgs/monster.png" width="50" height="50" draggable="false">
			</div>
		</div>	
    </body>
	
	
	
</html>
