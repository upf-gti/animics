<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Animics</title>
        <link rel="icon" type="image/x-icon" href="data/imgs/animics_monster.png" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:400,700" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic" rel="stylesheet" type="text/css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.css" rel="stylesheet" />

		<!-- <link rel="stylesheet" href="https://cdn.skypack.dev/lexgui@0.1.46/build/lexgui.css"> -->
		<link rel="stylesheet" href="./src/libs/lexgui/build/lexgui.css">
		<link rel="stylesheet" href="css/style.css">
    </head>

	<script src="src/libs/image-map-highlighter.js"></script>

	<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
	<script type="importmap">
			{
				"imports": {
					"three": "https://cdn.skypack.dev/three@0.136",
					
					"lexgui": "./src/libs/lexgui/build/lexgui.module.js",
					"lexgui/components/": "./src/libs/lexgui/build/components/"
				}
			}
	</script>

	<script  type="text/javascript" src="./src/libs/jszip.min.js"></script>
	
	<script type="module" src="src/CustomLibs.js"></script>
	<script type="text/javascript" src="src/timelineClips.js"></script>
	
	<script  type="module" src="./src/libs/lexgui/LexGUI.patches.js"></script>
	<script type="module">

		import { Animics } from './src/Animics.js'
		import { UTILS } from './src/Utils.js'
		import { LX } from 'lexgui';

		let area = LX.init( { strictViewport: false, rootClass: "" } );

		// Menubar
		{
			const menubar = area.addMenubar( m => {
				m.setButtonImage("Animics", "data/imgs/animics_logo.png", () => { window.location = window.location }, { float: "left" })
				m.add( "Docs/Keyframe Animation", { icon: "", callback: () => { window.open( "docs/keyframe_animation.html" , "_blank" ) } });
				m.add( "Docs/Script Animation", { icon: "", callback: () => { window.open( "docs/script_animation.html" , "_blank" ) } });
				m.add( "About", { icon: "", callback: () => window.__gtiContent.scrollIntoView({ behavior: 'smooth', block: 'start' }) });
				m.addButtons( [
					{
						title: "Github",
						icon: "fa-brands fa-github",
						callback:  (event) => {
							window.open( "https://github.com/upf-gti/animics/", "_blank" );
						}
					},
					{
						title: "Change Theme",
						icon: "fa-solid fa-sun",
						swap: "fa-solid fa-moon",
						callback:  (swapValue) => { LX.setTheme( swapValue ? "light" : "dark" ) }
					}
				]);

				const startButton = LX.makeContainer( ["auto", "32px"], "text-md font-medium rounded-lg px-2 ml-auto bg-accent fg-white hover:bg-mix self-center content-center text-center cursor-pointer select-none", "Get Started", m.root );
				startButton.tabIndex = "1";
				startButton.role = "button";
				startButton.listen( "click", () => window.__startingContent.scrollIntoView({ behavior: 'smooth', block: 'start' }) );
			});

			area = menubar.siblingArea;
			area.root.style.placeContent = "center";
			area.root.classList.add( "hidden" );
		}

		const content = LX.makeContainer( ["100%", "auto"], "wrapper flex flex-col", "", area );

		const headerContent = LX.makeContainer( ["100%", "auto"], "flex flex-col items-center my-4", "", content );
		const mainLogo = document.createElement( "img" );
		mainLogo.src = "docs/animics_name.png";
		mainLogo.style.width = "400px";
		mainLogo.className = "theme-image mt-8";
		headerContent.appendChild( mainLogo );
		const mainTitle = LX.makeContainer( ["100%", "auto"], "font-medium pt-3 pb-6 text-center tracking-tight", "Express more. Animate easier.", headerContent, { fontSize: "72px" } );
		const subtitle = LX.makeContainer( ["40%", "auto"], "text-xxl font-medium fg-tertiary text-center leading-7", "End-to-end system able to generate animations of the signing avatar from user input.", headerContent );

		const startButton = LX.makeContainer( ["20%", "auto"], "text-xxl font-medium rounded-lg p-4 my-12 bg-accent fg-white hover:bg-mix text-center cursor-pointer select-none", "Get started", headerContent );
		startButton.tabIndex = "1";
		startButton.role = "button";
		startButton.listen( "click", () => window.__startingContent.scrollIntoView({ behavior: 'smooth', block: 'start' }) );

		const mainCards = LX.makeContainer( ["100%", "600px"], "flex flex-row p-4 gap-4", "", headerContent );
		const mediaCardSources = [ "docs/bml_animation.mp4", "docs/bml_animation.mp4", "docs/bml_animation.mp4", "docs/bml_animation.mp4" ];

		for( const mediaIdx in mediaCardSources )
		{
			const cardWidth = 100 / mediaCardSources.length;
			const card = LX.makeContainer( [`${ cardWidth }%`, "100%"], "", "", mainCards );
			const videoElement = document.createElement( "video" );
			videoElement.src = mediaCardSources[ mediaIdx ];
			videoElement.style.width = "100%";
			videoElement.style.height = "100%";
			videoElement.style.objectFit = "cover";
			videoElement.style.borderRadius = "0.75rem";
			videoElement.toggleAttribute( "autoplay" );
			videoElement.toggleAttribute( "loop" );
			videoElement.toggleAttribute( "muted" );
			card.appendChild( videoElement );
		}

		// About Animics
		{
			const aboutContent = LX.makeContainer( ["100%", "auto"], "flex flex-col my-4 border-top items-end text-end", "", content );
			const aboutTitle = LX.makeContainer( ["60%", "auto"], "font-medium tracking-tight p-4 mt-4", "Discover Animics.", aboutContent, { fontSize: "56px" } );
			const aboutSubtitle = LX.makeContainer( ["50%", "auto"], "text-xxl font-medium fg-tertiary px-4", "Animics is an online application to create and edit animations for 3D humanoid characters, focused in Sign Language synthesis.", aboutContent, { lineHeight: "1.6rem" } );
			const aboutContainer = LX.makeContainer( ["100%", "512px"], "flex flex-row p-6 gap-2 mt-4", "", aboutContent );

			const utilitiesPreview = LX.makeContainer( ["65%", "100%"], "", "", aboutContainer );
			const videoElement = document.createElement( "video" );
			videoElement.src = "docs/bml_animation.mp4";
			videoElement.style.width = "100%";
			videoElement.style.height = "100%";
			videoElement.style.objectFit = "cover";
			videoElement.style.borderRadius = "0.75rem";
			videoElement.toggleAttribute( "autoplay" );
			videoElement.toggleAttribute( "loop" );
			videoElement.toggleAttribute( "muted" );
			utilitiesPreview.appendChild( videoElement );

			{
				const aboutItems = LX.makeContainer( ["35%", "100%"], "flex flex-col justify-around", "", aboutContainer );

				const makeAboutItem = ( title ) => {
					const item = LX.makeContainer( ["100%", "auto"], `flex flex-row gap-2 p-2 select-none items-center justify-end`, "", aboutItems );
					LX.makeContainer( ["auto", "auto"], "font-medium text-xl fg-tertiary line-clamp-1", title, item );
					const icon = LX.makeIcon( "circle-check", { svgClass: "xl" } );
					item.appendChild( icon );
				};

				const items = [ "From videos", "From webcam captures", "From phonetic descriptions", "Export animations", "Animations Storage", "Face and body edition", "Inverse kinematics" ];
				items.forEach( e => makeAboutItem( e ) )
			}
		}

		// Utilities
		{
			const utilitiesContent = LX.makeContainer( ["100%", "auto"], "flex flex-col my-4 border-top", "", content );
			const mainUtilitiesTitle = LX.makeContainer( ["60%", "auto"], "font-medium tracking-tight p-4 mt-4", "Create stunning 3D animations from simple videos.", utilitiesContent, { fontSize: "56px" } );
			const utilitiesSubtitle = LX.makeContainer( ["40%", "auto"], "text-xxl font-medium fg-tertiary px-4", "Transform raw footage into professional animations in four easy steps.", utilitiesContent, { lineHeight: "1.6rem" } );
			const utilitiesContainer = LX.makeContainer( ["100%", "512px"], "flex flex-row p-6 gap-2 mt-4", "", utilitiesContent );
			const utilitiesItems = LX.makeContainer( ["35%", "100%"], "flex flex-col gap-2 p-4", "", utilitiesContainer );

			const makeUtility = ( title, subtitle, src, selected ) => {
				const item = LX.makeContainer( ["100%", "25%"], `flex flex-col justify-center gap-1 p-6 rounded-lg cursor-pointer select-none hover:bg-secondary ${ selected ? "bg-secondary" : "" }`, "", utilitiesItems );
				LX.makeContainer( ["100%", "auto"], "font-medium text-xl", title, item );
				LX.makeContainer( ["100%", "auto"], "font-medium text-md fg-tertiary line-clamp-3", subtitle, item );
				item.listen( "click", function() {
					videoElement.src = src;
					utilitiesItems.querySelectorAll( ".bg-secondary" ).forEach( e => e.classList.remove( "bg-secondary" ) );
					this.classList.add( "bg-secondary" );
				} );
			};

			// Items
			{
				makeUtility( "Effortless video import", "Upload any video - from smartphone footage to online clips. Our AI instantly extracts precise motion data.", "docs/bml_animation.mp4", true );
				makeUtility( "Seamless model animation", "Import your 3D character and apply extracted motion. Blinking and physics are supported for MMD and VRM models.", "docs/bml_animation.mp4" );
				makeUtility( "Intuitive video direction", "Just a few clicks for lighting and camera control. Add cinematic effects like motion blur and depth-of-field", "docs/bml_animation.mp4" );
				makeUtility( "Versatile export options", "Generate high-quality video renders or export 3D assets compatible with industry-standard tools like Unreal, Maya, and Blender.", "docs/bml_animation.mp4" );
			}

			const utilitiesPreview = LX.makeContainer( ["65%", "100%"], "", "", utilitiesContainer );
			const videoElement = document.createElement( "video" );
			videoElement.src = "docs/bml_animation.mp4";
			videoElement.style.width = "100%";
			videoElement.style.height = "100%";
			videoElement.style.objectFit = "cover";
			videoElement.style.borderRadius = "0.75rem";
			videoElement.toggleAttribute( "autoplay" );
			videoElement.toggleAttribute( "loop" );
			videoElement.toggleAttribute( "muted" );
			utilitiesPreview.appendChild( videoElement );
		}

		// Getting started
		{
			const startingContent = LX.makeContainer( ["100%", "auto"], "flex flex-col mt-4 mb-8 items-center border-top", "", content );
			window.__startingContent = startingContent;
			const startingTitle = LX.makeContainer( ["60%", "auto"], "font-medium p-4 mt-4 text-center tracking-tight", "Getting started.", startingContent, { fontSize: "72px" } );
			const startingSubtitle = LX.makeContainer( ["40%", "auto"], "text-xxl font-medium fg-tertiary text-center px-4 leading-7", "Start new animation project based on text or video.", startingContent );
			const buttons = LX.makeContainer( ["100%", "auto"], "flex flex-col items-center mt-8", `
				<div class="flex flex-row gap-4">
					<a role="button" id="script-project" class="text-xl font-medium rounded-lg p-4 my-4 bg-contrast fg-contrast hover:bg-mix-contrast px-12 cursor-pointer select-none" title="From text instructions">Script animation</a>
					<a role="button" id="keyframe-project" class="text-xl font-medium rounded-lg p-4 my-4 bg-accent fg-white hover:bg-mix px-12 cursor-pointer select-none" title="From video or webcam input">Keyframe animation</a>
				</div>
				<p class="text-lg fg-secondary p-4">or</p>
			`, startingContent );
			const fileDropZone = LX.makeContainer( ["50%", "128px"], "font-medium text-xxl rounded-lg content-center bg-secondary hover:bg-mix border-colored border-dashed fg-primary text-center p-4 mt-4 cursor-pointer select-none", "Import video or animation", buttons );
			fileDropZone.id = "import";
			fileDropZone.tabIndex = "1";
			LX.makeContainer( ["100%", "auto"], "text-md fg-tertiary text-center px-4 leading-7", "mp4, bvh, bvhe, bml, sigml, json", fileDropZone );
		}

		// GTI
		{
			const gtiContent = LX.makeContainer( ["100%", "auto"], "flex flex-col mt-4 mb-8 border-top", "", content );
			window.__gtiContent = gtiContent;
			const gtiTitle = LX.makeContainer( ["60%", "auto"], "font-medium tracking-tight p-4 mt-4", "About us.", gtiContent, { fontSize: "56px" } );
			const gtiData = LX.makeContainer( ["100%", "auto"], "flex flex-row", "", gtiContent );
			const gtiSubtitle = LX.makeContainer( ["80%", "auto"], "text-lg fg-tertiary px-4", `
				This application is developed by the <a href="https://www.upf.edu/web/gti">Interactive Research Group (GTI)</a>, which is a research group within the Escola d'Enginyeria at Universitat Pompeu Fabra. The GTI focuses on human aspects and technology, especially those related to enhancing people's use of computer technologies, including technological and HCI research. The group integrates
				researchers in the areas of Human-Computer Interaction and Advanced 3D Graphics.
			`, gtiData, { lineHeight: "1.8rem" } );
			const funding = LX.makeContainer( ["20%", "auto"], "flex flex-col gap-4 ml-auto", `
				<img src="data/imgs/marco_SignON.png">
				<img src="data/imgs/marco_EMERALD.png">
			`, gtiData );
		}

		const footer = new LX.Footer( {
			className: "border-top",
			parent: LX.root,
			columns: [
				{
					title: "Applications",
					items: [
						{ title: `<img src = "data/imgs/performs_monster.png" width = "25px" draggable="false"> PERFORMS`, link: "https://performs.gti.upf.edu/" },
						{ title: `<img src = "data/imgs/animics_logo.png" width = "25px" draggable="false"> ANIMICS`, link: "https://animics.gti.upf.edu/" },
						{ title: `ATELIER`, link: "https://atelier.gti.upf.edu/" },
					]
				},
				{
					title: "Other GTI Projects",
					items: [
						{ title: `ROOMS`, link: "" },
						{ title: `wgpuEngine`, link: "" }
					]
				},
				{
					title: "UI/UX",
					items: [
						{ title: `LexGUI.js`, link: "https://github.com/jxarco/lexgui.js/" },
						{ title: `LexGUI Docs`, link: "https://github.com/jxarco/lexgui.js/docs" }
					]
				}
			],
			credits: `2021-${ new Date().getUTCFullYear() } GTI - UPF | Developed within <a href="https://signon-project.eu/" target="_blank">SignON</a> and EMERALD EU H2020 projects.<br>Released under the Apache 2.0 License.`,
			socials: [
				{ title: "Github", link: "https://github.com/upf-gti/", icon: `<i class="fa-brands fa-github"></i>` },
				{ title: "X/Twitter", link: "https://x.com/gti_upf/", icon: `<i class="fa-brands fa-x-twitter"></i>` }
			]
		} );

		const footerCreditsSocials = footer.root.querySelector( ".credits-and-socials" );
		footerCreditsSocials.innerHTML = `<img src="data/imgs/GTIlogo.png" width="250px" style="filter:invert(0.5)" draggable="false">` + footerCreditsSocials.innerHTML;

		const body = area.root;

		const keyframeBtn = document.getElementById("keyframe-project");
		// const videoBtn = document.getElementById("video-project");
		// const webcamBtn = document.getElementById("webcam-project");

		const scriptBtn = document.getElementById("script-project");
		const importBtn = document.getElementById("import");
		// const importScriptBtn = document.getElementById("import-script");

		// Wait until the session is loaded
		UTILS.makeLoading("Loading application, please wait");
		const animics = new Animics();
		await animics.loadSession();
		UTILS.hideLoading();
		body.classList.remove("hidden");

		const startAnimics = (settings) => {
			const loadingAnim = UTILS.makeLoading("Starting Animics");
			loadingAnim.onfinish = () => {
				// Manually resetting lexgui
				LX.root.innerHTML = "";
				LX.main_area = new LX.Area( { id: 'mainarea' } );
				LX.setStrictViewport( true );
				LX.doAsync( () => animics.init(settings), 150 );
			};			
			window.global = {app: animics};
		}
		
		const onLoadFiles = function( files ){
			if(!files || !files.length) { 
				return null; 
			}
			
			let mode = null;
			let resultFiles = [];
			
			const animExtensions = ['bvh','bvhe', 'glb'];
			const scriptExtensions = ['json', 'bml', 'sigml'];

			// First valid file will determine the mode. Following files must be of the same format
			for( let i = 0; i < files.length; ++i ) {
				// MIME type is video
				if( files[i].type.startsWith("video/") ) {
					if ( !mode ) { 
						mode = "keyframe"; 
					}
					
					if ( mode == "keyframe" ) {			
						resultFiles.push( files[i] );
					}
					continue;
				}

				// other valid file formats
				const extension = UTILS.getExtension(files[i].name).toLowerCase();
								
				if( animExtensions.includes(extension) ) {
					if ( !mode ) {
						mode = "keyframe";
					}
					
					if ( mode == "keyframe") {
						resultFiles.push( files[i] );
					}
				}

				if( scriptExtensions.includes(extension) ) {
					if ( !mode ) {
						mode = "script";
					}

					if ( mode == "script") {
						resultFiles.push( files[i] );
					}
				}
			}

			if ( resultFiles.length ) {
				return startAnimics({ mode, pendingResources: resultFiles});
			}	
				
			alert("Format not supported.\n\nFormats accepted:\n\tVideo: 'webm','mp4','ogv','avi'\n\tScript animation: 'bml', 'sigml', 'json'\n\tKeyframe animation: 'bvh', 'bvhe'");
			return null;
		}

		// Keyframe mode
		keyframeBtn.addEventListener("click", () => {
			startAnimics({mode: "keyframe"});
		});

		// Script mode
		scriptBtn.addEventListener("click", () => {
			startAnimics({mode: "script"});
		});

		// Import resurces 
		importBtn.addEventListener("click", () => {
    		const input = document.createElement('input');
    		input.type = 'file';
    		input.click();
    		input.onchange = (event) => { 
				onLoadFiles( event.currentTarget.files);
				// startAnimics({pendingResources: event.currentTarget.files})
			};
		});

		body.ondragover = () => {return false};
		body.ondragend = () => {return false};
		body.ondrop = (event) => {
			event.preventDefault();
			event.stopPropagation();
			if ( onLoadFiles( event.dataTransfer.files ) ){
				body.ondrop = null;
			}
		};
	</script>

    <body >
		<!-- Modals -->
		<div id="loading" class="modal hidden" style="opacity: 1; z-index: 1040">
			<div>
				<p>Loading application, please wait</p>
				<img class="loading-icon" src="data/imgs/monster.png" width="50" height="50" draggable="false">
			</div>
		</div>	
    </body>
	
	
	
</html>